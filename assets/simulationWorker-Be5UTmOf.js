(function(){"use strict";const W=[{hour:0,residential:.12,commercial:.15,Industrial:1,Community:.43},{hour:1,residential:.08,commercial:.15,Industrial:1,Community:.15},{hour:2,residential:.08,commercial:.15,Industrial:1,Community:.15},{hour:3,residential:.12,commercial:.15,Industrial:1,Community:.15},{hour:4,residential:.12,commercial:.15,Industrial:1,Community:.15},{hour:5,residential:.22,commercial:.15,Industrial:1,Community:.25},{hour:6,residential:.3,commercial:.15,Industrial:1,Community:.43},{hour:7,residential:.5,commercial:.15,Industrial:1,Community:.58},{hour:8,residential:.38,commercial:.55,Industrial:1,Community:.65},{hour:9,residential:.32,commercial:1,Industrial:1,Community:.65},{hour:10,residential:.32,commercial:1,Industrial:1,Community:.65},{hour:11,residential:.38,commercial:1,Industrial:1,Community:.65},{hour:12,residential:.4,commercial:1,Industrial:1,Community:.65},{hour:13,residential:.55,commercial:1,Industrial:1,Community:.65},{hour:14,residential:.48,commercial:1,Industrial:1,Community:.65},{hour:15,residential:.3,commercial:1,Industrial:1,Community:.65},{hour:16,residential:.3,commercial:1,Industrial:1,Community:.65},{hour:17,residential:.3,commercial:1,Industrial:1,Community:.75},{hour:18,residential:.55,commercial:.82,Industrial:1,Community:.84},{hour:19,residential:1,commercial:.65,Industrial:1,Community:1},{hour:20,residential:.78,commercial:.55,Industrial:1,Community:1},{hour:21,residential:.55,commercial:.15,Industrial:1,Community:1},{hour:22,residential:.48,commercial:.15,Industrial:1,Community:1},{hour:23,residential:.22,commercial:.15,Industrial:1,Community:.75}],x={residential:.9,commercial:.8,industrial:.75,community:.85},B={residential:1,commercial:.95,industrial:.9,community:.95},X={residential:.01,commercial:.02,industrial:.02,community:.01},U=.85,j=1,z=.05,G=.7,T=.3,H=24,r={isEnabled:!1,logLevel:"debug",log:function(...f){this.isEnabled&&["debug","info","error"].includes(this.logLevel)&&console.log(...f)},info:function(...f){this.isEnabled&&["info","debug"].includes(this.logLevel)&&console.info("INFO: ",...f)},error:function(...f){this.isEnabled&&["error","info","debug"].includes(this.logLevel)&&console.error("ERROR: ",...f)}};self.onmessage=function(f){try{console.log("Worker received message: ",f.data);const t=f.data;let A=Object.freeze({activeFeederBreakers:t.totalFeederBreakers,remainingESSEnergy:t.singleESSEnergy*t.essModuleCount,essChargeState:1,loadPowerFactor:Math.random()*(B.commercial-x.commercial)+x.commercial,loadVariation:.95});const N=Array.from({length:t.simulationTime},(D,o)=>{try{const w=Y({...A,variables:t,index:o});return A=Object.freeze({...A,remainingESSEnergy:w.remainingESSEnergy,activeFeederBreakers:w.activeFeederBreakers,essChargeState:w.essChargeState,loadPowerFactor:w.loadPowerFactor,loadVariation:w.loadVariation}),w}catch(w){throw console.error("Error in computeValue at index ${index}: ",w.message),w}});self.postMessage(N)}catch(t){r.error("Error in simulation worker: ",t.message),self.postMessage({error:t.message})}};function u(f,t){return f===0&&t===0?0:Math.sqrt(f**2/(f**2+t**2))}function Y({activeFeederBreakers:f,remainingESSEnergy:t,essChargeState:A,loadPowerFactor:N,loadVariation:D,variables:o,index:w}){r.log("Index: ",w),r.log("Peak Load: ",o.peakLoad),r.log("Active Feeder Breakers: ",f),r.log("Total Feeder Breakers: ",o.totalFeederBreakers);const $=Math.max(x.commercial,Math.min((1-Math.random()*2)*X.commercial+N,B.commercial)),q=Math.max(U,Math.min((1-Math.random()*2)*z+D,j)),V=W[Math.floor(w/o.granularity)%H].commercial*o.peakLoad*q/o.totalFeederBreakers,l=V*f;r.log("Real Load: ",l);const m=Math.sqrt((l/N)**2-l**2),J=Math.max(Math.sin((w%(H*o.granularity)-6*o.granularity)*15*Math.PI/(180*o.granularity)),0),i=o.peakPVPower*J*o.cloudingFactor;let P=0,I=f;const s=o.singleESSEnergy*o.essModuleCount,h=o.singleESSPeakPower*o.essModuleCount;let n=0,e=0,a=t,C=0,L=A,R=0,O=0,F=0;const y=o.singleGensetPower*o.gensetCount,p=o.singleGensetPower*.3,k=o.singleGensetPower*.7;let c=0,g=0,d=0,M=0,_=0;return r.log("availablePVPower: ",i),r.log("activeFeederBreakers: ",f),r.log("realLoad: ",l),r.log("remainingESSEnergy: ",t),o.utility?(r.log("Utility is available"),I=o.totalFeederBreakers,l<i?(r.log("realLoad < availablePVPower"),t<s?(n=m,e=-Math.min(i-l,h),a=t-1/o.granularity*e,C=u(e,n),a>s&&(a=s),i-l+e>0&&(R=-Math.min(i-l+e,o.utilityExportLimit),O=0,F=u(R,O)),P=l-e-R):(R=-Math.min(i-l,o.utilityExportLimit),O=m,F=u(R,O),P=l-R)):(r.log("not enough PV to cover the load"),i<=0?(r.log("no PV power available"),a<s?(r.log("no PV power and ESS not charged"),e=-Math.min(h,s-t),n=0,C=u(e,n),R=l+Math.min(h,s-t),O=m,F=u(R,O),a=t+1/o.granularity*h,a>s&&(a=s)):(R=l,O=m),F=u(R,O)):(r.log("PV and utility both available"),l-i<h&&t/s>T?(P=i,e=Math.min(l-i,t),n=m,C=u(e,n),a=t-1/o.granularity*e,R=0,O=0):(P=i,R=l-i,O=m,F=u(R,O))))):(r.log("No utility power available"),o.gensetCount===0?(r.log("No gensets, only PV and energy storage"),f<o.totalFeederBreakers&&(r.log("activeFeederBreakers < variables.totalFeederBreakers"),(i-l>=V||t>0&&i+h-l>=V)&&I++),l<i?t<s?(n=m,e=-Math.min(i-l,h,s-t),C=u(e,n),a=t-1/o.granularity*e,a>s&&(a=s),P=l-e):(P=l,e=0,n=m,C=u(e,n)):(r.log("less PV than the load requires"),t<=0?(r.log("ESS is discharged, shed load"),I=Math.floor(i/V),P=l,e=0,n=m,C=u(e,n)):l>i+h||l>i+t?(r.log("not enough capacity between the PV and ESS to support the load, shed load"),I=Math.floor(Math.min(i+h,i+t)/V),P=i,e=Math.min(l-i,t),n=m,C=u(e,n),a=t-1/o.granularity*e):(r.log("PV and energy storage is sufficient to power load"),P=i,e=l-i,n=m,C=u(e,n),a=t-1/o.granularity*e))):o.gensetCount>0&&o.essModuleCount===0?(r.log("Generator sets only, no ESS"),c=l-i,f<o.totalFeederBreakers&&i+y-l>=V&&I++,c<=0?(g=1,P=Math.max(l-p,0),d=p,M=m,_=u(d,M)):(r.log("not enough PV to power load"),c>y&&(I=Math.floor((i+y)/V)),g=Math.min(o.gensetCount,Math.ceil(c/k)),d=Math.max(g*p,c),P=Math.max(l-d,0),M=m,_=u(d,M))):o.gensetCount>0&&o.essModuleCount>0&&(r.log("Gensets, PV, and energy storage"),t>0&&f<o.totalFeederBreakers?i+y+h-l>=V&&I++:f<o.totalFeederBreakers&&i+y-l>=V&&I++,c=l-i,c<=0?(r.log("more PV than the load requires, run on PV and ESS"),g=0,t<s?(n=m,e=-Math.min(i-l,h,s-t),C=u(e,n),a=t-1/o.granularity*e,a>s&&(a=s),P=l-e,d=0,M=0,_=0,a/s>G&&(L=1)):(r.log("ESS does not require charging"),P=l,e=0,n=m,C=u(e,n),d=0,d=0,M=0,_=0)):(r.log("PV does not have enough power to run the load, run on PV + genset and/or energy storage"),A===1?c<t?(r.log("ESS can cover the load"),g=0,n=m,e=c,C=u(e,n),a=t-1/o.granularity*e,P=l-e,d=0,M=0,_=0,a/s<T&&(L=0)):(r.log("ESS can't cover complete load, use genset and/or ESS"),c>y+h&&c>y+t&&(I=Math.floor((i+y+h)/V)),g=Math.min(o.gensetCount,Math.ceil(c/k)),c/g<h&&c/g<t?(r.log("ESS can offset one genset"),g--,d=Math.max(p,c-h,c-t),M=m-m/g,_=u(d,M),e=c-d,n=m-M,C=u(e,n),a=t-1/o.granularity*e,a/s<T&&(L=0),P=l-d-e):c>y?(r.log("more power than the gensets can support, run ESS"),g=o.gensetCount,d=l-i-h,M=m*d/l,_=u(d,M),e=Math.min(h,t),n=m-M,C=u(e,n),a=t-1/o.granularity*e,a/s<T&&(L=0),P=l-d-e):(r.log("run on genset only and recharge the ESS"),g=Math.min(o.gensetCount,Math.ceil(c/k)),e=-Math.min(h,s-t,g*o.singleGensetPower-c),n=0,C=u(e,n),d=Math.max(g*p,c)-e,P=Math.max(l-d,0),M=m,_=u(d,M),a=t-1/o.granularity*e,a>s&&(a=s),t/s>G&&(L=1))):(r.log("ESS Charge State = 0, run on PV + Gensets"),c>y&&(t>0?(c>y+Math.min(h,t)&&(I=Math.floor(i+y+Math.min(h,t)/V)),g=o.gensetCount,d=l-i-Math.min(h,t),M=m*d/l,_=u(d,M),e=Math.min(h,t),n=m-M,C=u(e,n),a=t-1/o.granularity*e,a/s<T&&(L=0)):I=Math.floor(i+y/V)),g=Math.min(o.gensetCount,Math.ceil(c/k)),e=-Math.min(h,s-t,g*o.singleGensetPower-c),n=0,C=u(e,n),d=Math.max(g*p,c)-e,P=l-c,M=m,_=u(d,M),a=t-1/o.granularity*e,a>s&&(a=s),a/s>G&&(L=1))))),r.log("essRealPowerContribution: ",e),r.log("essReactivePowerContribution: ",n),r.log("newRemainingESSEnergy: ",a),r.log("newActiveFeederBreakers: ",I),r.log("gensetRealPowerRequirement: ",c),r.log("gensetsRequired: ",g),r.log("nextGensetOnlinePower: ",k),{index:w,activeFeederBreakers:I,remainingESSEnergy:a,totalESSEnergy:s,totalGensetPower:y,essChargeState:A,realLoad:l,loadPowerFactor:$,loadVariation:q,reactiveLoad:m,availablePVPower:i,providedPVPower:P,essReactivePowerContribution:n,essRealPowerContribution:e,essPowerFactor:C,utilityRealPowerContribution:R,utilityReactivePowerContribution:O,utilityPowerFactor:F,providedPVPower:P,gensetRealPowerContribution:d,gensetReactivePowerContribution:M,gensetPowerFactor:_,gensetsRequired:g,essChargeState:L}}})();
