(function(){"use strict";const D=[{hour:0,residential:.12,commercial:.15,Industrial:1,Community:.43},{hour:1,residential:.08,commercial:.15,Industrial:1,Community:.15},{hour:2,residential:.08,commercial:.15,Industrial:1,Community:.15},{hour:3,residential:.12,commercial:.15,Industrial:1,Community:.15},{hour:4,residential:.12,commercial:.15,Industrial:1,Community:.15},{hour:5,residential:.22,commercial:.15,Industrial:1,Community:.25},{hour:6,residential:.3,commercial:.15,Industrial:1,Community:.43},{hour:7,residential:.5,commercial:.15,Industrial:1,Community:.58},{hour:8,residential:.38,commercial:.55,Industrial:1,Community:.65},{hour:9,residential:.32,commercial:1,Industrial:1,Community:.65},{hour:10,residential:.32,commercial:1,Industrial:1,Community:.65},{hour:11,residential:.38,commercial:1,Industrial:1,Community:.65},{hour:12,residential:.4,commercial:1,Industrial:1,Community:.65},{hour:13,residential:.55,commercial:1,Industrial:1,Community:.65},{hour:14,residential:.48,commercial:1,Industrial:1,Community:.65},{hour:15,residential:.3,commercial:1,Industrial:1,Community:.65},{hour:16,residential:.3,commercial:1,Industrial:1,Community:.65},{hour:17,residential:.3,commercial:1,Industrial:1,Community:.75},{hour:18,residential:.55,commercial:.82,Industrial:1,Community:.84},{hour:19,residential:1,commercial:.65,Industrial:1,Community:1},{hour:20,residential:.78,commercial:.55,Industrial:1,Community:1},{hour:21,residential:.55,commercial:.15,Industrial:1,Community:1},{hour:22,residential:.48,commercial:.15,Industrial:1,Community:1},{hour:23,residential:.22,commercial:.15,Industrial:1,Community:.75}],x={residential:.9,commercial:.8,industrial:.75,community:.85},H={residential:1,commercial:.95,industrial:.9,community:.95},W={residential:.01,commercial:.02,industrial:.02,community:.01},B=.7,A=.3,q=24,r={isEnabled:!1,logLevel:"debug",log:function(...f){this.isEnabled&&["debug","info","error"].includes(this.logLevel)&&console.log(...f)},info:function(...f){this.isEnabled&&["info","debug"].includes(this.logLevel)&&console.info("INFO: ",...f)},error:function(...f){this.isEnabled&&["error","info","debug"].includes(this.logLevel)&&console.error("ERROR: ",...f)}};self.onmessage=function(f){try{console.log("Worker received message: ",f.data);const t=f.data;let O=Object.freeze({activeFeederBreakers:t.totalFeederBreakers,remainingESSEnergy:t.singleESSEnergy*t.essModuleCount,essChargeState:1,loadPowerFactor:Math.random()*(H.commercial-x.commercial)+x.commercial});const G=Array.from({length:t.simulationTime},(o,_)=>{try{const F=X({...O,variables:t,index:_});return O=Object.freeze({...O,remainingESSEnergy:F.remainingESSEnergy,activeFeederBreakers:F.activeFeederBreakers,essChargeState:F.essChargeState,loadPowerFactor:F.loadPowerFactor}),F}catch(F){throw console.error("Error in computeValue at index ${index}: ",F.message),F}});self.postMessage(G)}catch(t){r.error("Error in simulation worker: ",t.message),self.postMessage({error:t.message})}};function u(f,t){return f===0&&t===0?0:Math.sqrt(f**2/(f**2+t**2))}function X({activeFeederBreakers:f,remainingESSEnergy:t,essChargeState:O,loadPowerFactor:G,variables:o,index:_}){r.log("Index: ",_),r.log("Peak Load: ",o.peakLoad),r.log("Active Feeder Breakers: ",f),r.log("Total Feeder Breakers: ",o.totalFeederBreakers);const F=Math.max(x.commercial,Math.min((1-Math.random()*2)*W.commercial+G,H.commercial)),y=D[Math.floor(_/o.granularity)%q].commercial*o.peakLoad*F/o.totalFeederBreakers,l=y*f;r.log("Real Load: ",l);const m=Math.sqrt((l/G)**2-l**2),U=Math.max(Math.sin((_%(q*o.granularity)-6*o.granularity)*15*Math.PI/(180*o.granularity)),0),i=o.peakPVPower*U*o.cloudingFactor;let w=f;const s=o.singleESSEnergy*o.essModuleCount,h=o.singleESSPeakPower*o.essModuleCount;let n=0,e=0,a=t,C=0,V=O,R=0,p=0,k=0,M=0;const I=o.singleGensetPower*o.gensetCount,T=o.singleGensetPower*.3,N=o.singleGensetPower*.7;let c=0,P=0,d=0,g=0,L=0;return r.log("availablePVPower: ",i),r.log("activeFeederBreakers: ",f),r.log("realLoad: ",l),r.log("remainingESSEnergy: ",t),o.utility?(r.log("Utility is available"),w=o.totalFeederBreakers,l<i?(r.log("realLoad < availablePVPower"),t<s?(n=m,e=-Math.min(i-l,h),a=t-1/o.granularity*e,C=u(e,n),a>s&&(a=s),i-l+e>0&&(R=-Math.min(i-l+e,o.utilityExportLimit),p=0,k=u(R,p)),M=l-e-R):(R=-Math.min(i-l,o.utilityExportLimit),p=m,k=u(R,p),M=l-R)):(r.log("not enough PV to cover the load"),i<=0?(r.log("no PV power available"),a<s?(r.log("no PV power and ESS not charged"),e=-Math.min(h,s-t),n=0,C=u(e,n),R=l+Math.min(h,s-t),p=m,k=u(R,p),a=t+1/o.granularity*h,a>s&&(a=s)):(R=l,p=m),k=u(R,p)):(r.log("PV and utility both available"),l-i<h&&t/s>A?(M=i,e=Math.min(l-i,t),n=m,C=u(e,n),a=t-1/o.granularity*e,R=0,p=0):(M=i,R=l-i,p=m,k=u(R,p))))):(r.log("No utility power available"),o.gensetCount===0?(r.log("No gensets, only PV and energy storage"),f<o.totalFeederBreakers&&(r.log("activeFeederBreakers < variables.totalFeederBreakers"),(i-l>=y||t>0&&i+h-l>=y)&&w++),l<i?t<s?(n=m,e=-Math.min(i-l,h,s-t),C=u(e,n),a=t-1/o.granularity*e,a>s&&(a=s),M=l-e):(M=l,e=0,n=m,C=u(e,n)):(r.log("less PV than the load requires"),t<=0?(r.log("ESS is discharged, shed load"),w=Math.floor(i/y),M=l,e=0,n=m,C=u(e,n)):l>i+h||l>i+t?(r.log("not enough capacity between the PV and ESS to support the load, shed load"),w=Math.floor(Math.min(i+h,i+t)/y),M=i,e=Math.min(l-i,t),n=m,C=u(e,n),a=t-1/o.granularity*e):(r.log("PV and energy storage is sufficient to power load"),M=i,e=l-i,n=m,C=u(e,n),a=t-1/o.granularity*e))):o.gensetCount>0&&o.essModuleCount===0?(r.log("Generator sets only, no ESS"),c=l-i,f<o.totalFeederBreakers&&i+I-l>=y&&w++,c<=0?(P=1,M=Math.max(l-T,0),d=T,g=m,L=u(d,g)):(r.log("not enough PV to power load"),c>I&&(w=Math.floor((i+I)/y)),P=Math.min(o.gensetCount,Math.ceil(c/N)),d=Math.max(P*T,c),M=Math.max(l-d,0),g=m,L=u(d,g))):o.gensetCount>0&&o.essModuleCount>0&&(r.log("Gensets, PV, and energy storage"),t>0&&f<o.totalFeederBreakers?i+I+h-l>=y&&w++:f<o.totalFeederBreakers&&i+I-l>=y&&w++,c=l-i,c<=0?(r.log("more PV than the load requires, run on PV and ESS"),P=0,t<s?(n=m,e=-Math.min(i-l,h,s-t),C=u(e,n),a=t-1/o.granularity*e,a>s&&(a=s),M=l-e,d=0,g=0,L=0,a/s>B&&(V=1)):(r.log("ESS does not require charging"),M=l,e=0,n=m,C=u(e,n),d=0,d=0,g=0,L=0)):(r.log("PV does not have enough power to run the load, run on PV + genset and/or energy storage"),O===1?c<t?(r.log("ESS can cover the load"),P=0,n=m,e=c,C=u(e,n),a=t-1/o.granularity*e,M=l-e,d=0,g=0,L=0,a/s<A&&(V=0)):(r.log("ESS can't cover complete load, use genset and/or ESS"),c>I+h&&c>I+t&&(w=Math.floor((i+I+h)/y)),P=Math.min(o.gensetCount,Math.ceil(c/N)),c/P<h&&c/P<t?(r.log("ESS can offset one genset"),P--,d=Math.max(T,c-h,c-t),g=m-m/P,L=u(d,g),e=c-d,n=m-g,C=u(e,n),a=t-1/o.granularity*e,a/s<A&&(V=0),M=l-d-e):c>I?(r.log("more power than the gensets can support, run ESS"),P=o.gensetCount,d=l-i-h,g=m*d/l,L=u(d,g),e=Math.min(h,t),n=m-g,C=u(e,n),a=t-1/o.granularity*e,a/s<A&&(V=0),M=l-d-e):(r.log("run on genset only and recharge the ESS"),P=Math.min(o.gensetCount,Math.ceil(c/N)),e=-Math.min(h,s-t,P*o.singleGensetPower-c),n=0,C=u(e,n),d=Math.max(P*T,c)-e,M=Math.max(l-d,0),g=m,L=u(d,g),a=t-1/o.granularity*e,a>s&&(a=s),t/s>B&&(V=1))):(r.log("ESS Charge State = 0, run on PV + Gensets"),c>I&&(t>0?(c>I+Math.min(h,t)&&(w=Math.floor(i+I+Math.min(h,t)/y)),P=o.gensetCount,d=l-i-Math.min(h,t),g=m*d/l,L=u(d,g),e=Math.min(h,t),n=m-g,C=u(e,n),a=t-1/o.granularity*e,a/s<A&&(V=0)):w=Math.floor(i+I/y)),P=Math.min(o.gensetCount,Math.ceil(c/N)),e=-Math.min(h,s-t,P*o.singleGensetPower-c),n=0,C=u(e,n),d=Math.max(P*T,c)-e,M=l-c,g=m,L=u(d,g),a=t-1/o.granularity*e,a>s&&(a=s),a/s>B&&(V=1))))),r.log("essRealPowerContribution: ",e),r.log("essReactivePowerContribution: ",n),r.log("newRemainingESSEnergy: ",a),r.log("newActiveFeederBreakers: ",w),r.log("gensetRealPowerRequirement: ",c),r.log("gensetsRequired: ",P),r.log("nextGensetOnlinePower: ",N),{index:_,activeFeederBreakers:w,remainingESSEnergy:a,totalESSEnergy:s,totalGensetPower:I,essChargeState:O,realLoad:l,loadPowerFactor:F,reactiveLoad:m,availablePVPower:i,essReactivePowerContribution:n,essRealPowerContribution:e,essPowerFactor:C,utilityRealPowerContribution:R,utilityReactivePowerContribution:p,utilityPowerFactor:k,providedPVPower:M,gensetRealPowerContribution:d,gensetReactivePowerContribution:g,gensetPowerFactor:L,gensetsRequired:P,essChargeState:V}}})();
